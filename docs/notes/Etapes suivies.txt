											---------------------------------------
											 P4L1 - Prj. TomTroc - Etapes suivies
												Date : Samdi 6 décembre 2025
												Maj : Dimanche 14 décembre 2025   
											---------------------------------------
											
1. ANALYSE DU PROJET
	a) Commande sur site OC
	
	b) Spécifications fonctionnelles
	
	c) Maquette et prototype du site 
	
2. INITIALISATION DU PROJET
	BDD : tomtroc
		Relations entre les tables :
		--------------------------
			Voir aussi la représentation ERD (Entity Relation Diagram) sous :
				/docs/architecture/erd_tomtroc.puml

			1. users ↔ books
				Relation : 1 utilisateur possède plusieurs livres (1-N) :
					books.user_id  →  users.id
				Contrainte (suppression en cascade - éviter les données orphelines) :
					CONSTRAINT fk_books_user
						FOREIGN KEY (user_id) REFERENCES users(id)
						ON DELETE CASCADE
	
			2. users ↔ messages (expéditeur)
				Relation : 1 utilisateur peut envoyer plusieurs messages (1-N)	
					messages.sender_id → users.id
					
			3. users ↔ messages (destinataire)
				Relation : 1 utilisateur peut recevoir plusieurs messages (1-N)	
				
				→ Le modèle "messagerie" est donc défini avec deux FK pointant vers la même table users.
	
		Création de BDD : tomtroc
		-------------------------
			CREATE DATABASE IF NOT EXISTS tomtroc
			  CHARACTER SET utf8mb4
			  COLLATE utf8mb4_unicode_ci;

			USE tomtroc;

			CREATE TABLE users (
				id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
				pseudo VARCHAR(50) NOT NULL,
				email VARCHAR(255) NOT NULL,
				password_hash VARCHAR(255) NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
				updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
				CONSTRAINT uq_users_email UNIQUE (email),
				CONSTRAINT uq_users_pseudo UNIQUE (pseudo)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


			CREATE TABLE books (
				id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
				user_id INT UNSIGNED NOT NULL,
				title VARCHAR(255) NOT NULL,
				author VARCHAR(255) NOT NULL,
				description TEXT NOT NULL,
				image_path VARCHAR(255) NULL,
				status ENUM('available', 'unavailable') NOT NULL DEFAULT 'available',
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
				updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

				CONSTRAINT fk_books_user
					FOREIGN KEY (user_id) REFERENCES users(id)
					ON DELETE CASCADE,

				INDEX idx_books_user (user_id),
				INDEX idx_books_status (status),
				INDEX idx_books_title (title)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


			CREATE TABLE messages (
				id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
				sender_id INT UNSIGNED NOT NULL,
				receiver_id INT UNSIGNED NOT NULL,
				content TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
				updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
				read_at DATETIME NULL DEFAULT NULL,

				CONSTRAINT fk_messages_sender
					FOREIGN KEY (sender_id) REFERENCES users(id)
					ON DELETE CASCADE,

				CONSTRAINT fk_messages_receiver
					FOREIGN KEY (receiver_id) REFERENCES users(id)
					ON DELETE CASCADE,

				INDEX idx_messages_receiver_created (receiver_id, created_at),
				INDEX idx_messages_pair (sender_id, receiver_id, created_at)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
	
	
		Git/Gihub :
		---------
			Création de la repo. github : oc-4-1-TomTroc
			
			git init
			git add .
			git commit -m "Initial commit – project structure + SQL schema + base MVC"
			git branch -M main
			git remote add origin https://github.com/toncompte/oc-4-1-TomTroc.git
			git push -u origin main	

3. CREATION/MISE EN PLACE DU SQUELETTE MVC
	- Structure du project
	- Autoloader (spl) (suppression de composer/phpdotenv car non autorisé dans le prj)
	- router
	- front controller
	- Gestion des erreurs (403 / 404 / 500)
	- Système de configuration
	- Rendu MVC
	- Layouts
	- Database manager

	git add .
	git commit -m "feat(core): implement MVC foundation, routing, config system and error handling

	- Added custom autoloader
	- Implemented centralized configuration system (Config class + /config files)
	- Added front controller with global exception handling (DEV/PROD modes)
	- Added HTTP error handling (403, 404, 500) with dedicated views
	- Improved Router to throw HTTP exceptions
	- Added base Controller with render() and renderError() workflows
	- Implemented unified layouts for normal and error views
	- Create & Updated Database manager to use config system
	- Clean project structure and prepared foundation for feature development
	"

4. CRÉATION DS FEATURES

	1) FEATURE AUTH
	===============

		BRANCHE
		-------
			git checkout -b feature/auth

		OBJECTIF
		--------
			Implémenter un système complet d'authentification :
				- Session sécurisée
				- Inscription
				- Connexion
				- Déconnexion
				- Page Mon Compte
				- Gestion des erreurs et messages flash

		A) SESSION
		----------
			Ajout /app/Core/Session.php
			Adaptation du front-controller (public/index.php)

			PRINCIPE DE FONCTIONNEMENT
			--------------------------
				• Connexion réussie :
					Session::set('user_id', $user->getId());
					Session::addFlash('success', 'Connexion réussie.');

				• Vérification d'accès :
					if (! Session::isLogged()) {
						throw new HttpForbiddenException(
							'Vous devez être connecté pour accéder à cette page.'
						);
					}

				• Déconnexion :
					Session::destroy();

				• Messages flash dans le layout :
					$success = Session::getFlashes('success');
					$errors  = Session::getFlashes('error');

		B) AUTHENTIFICATION
		-------------------
			1. Modèle User : app/Models/User.php
				Roles du modèle :
					(1) Représenter les données venant de la BDD (hydratation)
					(2) Représenter les données venant du formulaire (front)
				Workflow MVC :
					Front → Controller → Validation → User (modèle) → Repository → BDD
					BDD   → Repository → User (modèle) → Controller → Vue

			2. UserRepository : app/Repositories/UserRepository.php
				- findByEmail()
				- findByPseudo()
				- findById()
				- create()
				- verifyCredentials()
				- hydrateUser()

			3. AuthController : app/Controllers/AuthController.php
				- registerForm()
				- register()
				- loginForm()
				- login()
				- logout()

			4. Vues :
				views/auth/register.php
				views/auth/login.php

			5. Ajout des routes :
				GET  /register
				POST /register
				GET  /login
				POST /login
				GET  /logout

		C) COMPTE UTILISATEUR
		---------------------
			Contrôleur :
				app/Controllers/AccountController.php

			Vue :
				views/account/index.php

			Nouvelle route :
				GET /account   (accès restreint)

		D) VERSIONING GIT/GITHUB
		------------------------
			git status
			git add .
			git commit -m "feat(auth): implement full authentication module

			- Added AuthController (register/login/logout)
			- Added AccountController and /account protected page
			- Added register and login views (flash + old values)
			- Extended Session with flash system + getUserId()
			- Added User model (pseudo, email, passwordHash)
			- Added UserRepository (find, create, credentials)
			- Added routes + access control via HttpForbiddenException
			"

			git push origin feature/auth

			Sur GitHub :
				- Créer la Pull Request
				- Rédiger titre + description
				- Merger
				- Supprimer la branche distante

			En local :
				git checkout main
				git pull
				git branch -d feature/auth

	2) FEATURE BOOKS
	================

		BRANCHE
		-------
			git checkout -b feature/books

		OBJECTIF
		--------
			Implémenter la gestion complète des livres :
				- Ajout d’un livre par un utilisateur connecté
				- Modification et suppression de ses propres livres
				- Consultation publique des livres
				- Affichage des livres de l’utilisateur dans "Mon compte"
				- Gestion de l’upload d’image
				- Affichage des derniers livres sur la page d’accueil

		A) ENTITE BOOK
		--------------
			Fichier :
				app/Models/Book.php

			Rôle du modèle :
				(1) Représenter un livre issu de la BDD (hydratation)
				(2) Représenter un livre en cours de création/modification (formulaire)
				(3) Porter les règles métier simples (statut, setters sécurisés)

			Champs principaux :
				- id
				- user_id (propriétaire)
				- title
				- author
				- description
				- image_path
				- status
				- created_at / updated_at (gérés par la BDD)

			Workflow MVC :
				Front → Controller → Validation → Book (modèle) → Repository → BDD
				BDD   → Repository → Book (modèle) → Controller → Vue

		B) PERSISTANCE (BOOK REPOSITORY)
		--------------------------------
			Fichier :
				app/Repositories/BookRepository.php

			Méthodes :
				- findById()
				- findByUser()
				- findAvailable()
				- findLast()
				- create()
				- update()
				- delete()
				- hydrateBook()

			Responsabilité :
				- Accès à la base de données uniquement
				- Aucune logique HTTP
				- Aucune logique de session

		C) CONTROLEUR BOOK
		------------------
			Fichier :
				app/Controllers/BookController.php

			Méthodes :
				- show()       → affichage public du détail d’un livre
				- addForm()    → formulaire d’ajout (accès restreint)
				- add()        → traitement ajout + upload image
				- editForm()   → formulaire d’édition (propriétaire uniquement)
				- edit()       → traitement modification
				- delete()     → suppression d’un livre

			Règles de sécurité :
				- Utilisateur connecté requis pour add / edit / delete
				- Vérification du propriétaire du livre
				- Exceptions HTTP (403 / 404) en cas d’erreur

		D) UPLOAD DES IMAGES
		-------------------
			Dossier :
				public/uploads/books/

			Principe :
				- Image optionnelle
				- Validation du type MIME
				- Nom de fichier unique (uniqid)
				- Stockage du chemin relatif en BDD
				- Une seule image haute résolution (x4)
				- Redimensionnement via CSS selon la page

		E) VUES BOOK
		------------
			Dossier :
				views/book/

			Fichiers :
				- add.php   → formulaire ajout
				- edit.php  → formulaire édition
				- show.php  → détail public d’un livre

			Règle :
				- Aucune logique métier
				- Affichage uniquement

		F) INTEGRATION DANS LE COMPTE UTILISATEUR
		-----------------------------------------
			Contrôleur :
				app/Controllers/AccountController.php

			Adaptation :
				- Récupération des livres du user connecté
				- Affichage dans la section "Ma bibliothèque"

			Vue :
				views/account/index.php
					- Liste des livres
					- Boutons Modifier / Supprimer
					- Lien Ajouter un livre

		G) PAGE D’ACCUEIL
		-----------------
			Objectif :
				- Afficher les derniers livres ajoutés

			Implémentation :
				- BookRepository::findLast()
				- Appel depuis HomeController
				- Affichage dans la vue home/index.php

		H) ROUTES
		---------
			$router->get('/book/{id}', [BookController::class, 'show']);

			$router->get('/book/add', [BookController::class, 'addForm']);
			$router->post('/book/add', [BookController::class, 'add']);

			$router->get('/book/{id}/edit', [BookController::class, 'editForm']);
			$router->post('/book/{id}/edit', [BookController::class, 'edit']);

			$router->post('/book/{id}/delete', [BookController::class, 'delete']);

		I) VERSIONING GIT / GITHUB
		--------------------------
			git status
			git add .
			git commit -m "feat(books): implement book CRUD with image upload and home listing

			- Added Book model and BookRepository
			- Added BookController (CRUD + access control)
			- Implemented image upload for books
			- Integrated user books into account page
			- Added public book detail page
			- Displayed last books on home page
			"

			git push origin feature/books

			Sur GitHub :
				- Créer la Pull Request
				- Rédiger titre + description
				- Merger
				- Supprimer la branche distante

			En local :
				git checkout main
				git pull
				git branch -d feature/books
				git branch
				git branch -r


	3) FEATURE BOOKS-PUBLIC
	======================

		BRANCHE
		-------
			git checkout -b feature/books-public

		OBJECTIF
		--------
			Implémenter la consultation publique des livres :
				- Page "Nos livres à l’échange"
				- Recherche par titre
				- Accès au détail d’un livre
				- Navigation publique sans authentification
				- Séparation claire livres publics / espace utilisateur

		A) PAGE PUBLIQUE "NOS LIVRES À L’ÉCHANGE"
		----------------------------------------
			URL :
				GET /books

			Rôle :
				- Afficher la liste des livres disponibles à l’échange
				- Permettre une recherche par titre
				- Donner accès à la page de détail d’un livre

			Implémentation :
				- BookController::index()
				- Transmission des données à la vue book/index.php

			Fonctionnalités :
				- Récupération des livres avec statut "available"
				- Filtrage optionnel via paramètre GET ?q=
				- Affichage de l’image, du titre, de l’auteur
				- Lien vers le détail du livre

		B) ADAPTATION DU BOOK CONTROLLER
		--------------------------------
			Fichier :
				app/Controllers/BookController.php

			Méthodes concernées :
				- index()   → page publique /books
				- show()    → détail public d’un livre

			Responsabilités :
				- Récupérer les paramètres HTTP (GET)
				- Appeler le repository
				- Aucune logique métier
				- Aucune logique SQL

		C) ADAPTATION DU BOOK REPOSITORY
		--------------------------------
			Fichier :
				app/Repositories/BookRepository.php

			Nouvelles / adaptations de méthodes :
				- findAllAvailable(?string $search = null)

			Rôle :
				- Retourner uniquement les livres disponibles
				- Appliquer un filtre de recherche si présent
				- Ne jamais dépendre du HTTP ou de la session

			Règle :
				- Toute logique SQL reste confinée au repository

		D) VUE BOOK INDEX
		-----------------
			Fichier :
				views/book/index.php

			Responsabilité :
				- Affichage uniquement
				- Aucune logique métier
				- Aucune requête SQL

			Contenu :
				- Formulaire de recherche (GET)
				- Liste des livres disponibles
				- Image cliquable menant au détail
				- Message si aucun résultat

		E) PAGE "DÉTAIL D’UN LIVRE"
		---------------------------
			URL :
				GET /book/{id}

			Implémentation :
				- BookController::show()
				- Vue : views/book/show.php

			Fonction :
				- Affichage public des informations complètes du livre
				- Image en grand format
				- Titre, auteur, description
				- Propriétaire du livre

			Accès :
				- Public (aucune authentification requise)

		F) ROUTES PUBLIQUES
		-------------------
			Fichier :
				app/Routes/web.php

			Routes ajoutées / utilisées :
				$router->get('/books', [BookController::class, 'index']);
				$router->get('/book/{id}', [BookController::class, 'show']);

			Principe :
				- Routes isolées dans un fichier dédié
				- Aucune logique métier dans les routes

		G) ADAPTATIONS TRANSVERSES
		--------------------------
			Corrections / ajustements :
				- Amélioration de certaines vues existantes
				- Harmonisation des liens de navigation
				- Ajustements mineurs de repositories
				- Sécurisation de l’affichage (htmlspecialchars)

		H) VERSIONING GIT / GITHUB
		--------------------------
			git status
			git add .
			git commit -m "feat(books-public): public books listing with search and book detail links"

			git push origin feature/books-public

			Sur GitHub :
				- Créer la Pull Request
				- Rédiger titre + description
				- Merger dans main
				- Supprimer la branche distante

			En local :
				git checkout main
				git pull
				git branch -d feature/books-public
				git branch
				git branch -r
			

	4) FEATURE MESSAGING
	====================			

		BRANCHE
		-------
			git checkout -b feature/messaging	

